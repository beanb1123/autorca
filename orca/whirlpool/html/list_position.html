<html>
<head>
    <title>Whirlpool Position Closer</title>
    <meta charset="utf-8" />

    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css' />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.0/decimal.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <style>
      body { font-family: Verdana, Geneva, Tahoma, sans-serif; font-size: small; background-color: white; }
      thead { background-color: #eeeeee; }
      tr.above, tr.below { background-color: #ffcccc; }
      a { text-decoration: none; }
      a, a:hover, a:visited { color: inherit; }
      td.empty-table { min-width: 500px; height: 100px; text-align: center; }
    </style>

    <!-- toastr -->
    <script>
        toastr.options = {
          "closeButton": false,
          "debug": false,
          "newestOnTop": false,
          "progressBar": false,
          "positionClass": "toast-bottom-full-width",
          "preventDuplicates": false,
          "onclick": null,
          "showDuration": "300",
          "hideDuration": "1000",
          "timeOut": "3000",
          "extendedTimeOut": "1000",
          "showEasing": "swing",
          "hideEasing": "linear",
          "showMethod": "fadeIn",
          "hideMethod": "fadeOut"
        }

        function show_toastr(toast_type, message) { $(window).prop("toastr")[toast_type](message); }
        function notify_success(message) { show_toastr("success", message); }
        function notify_info(message) { show_toastr("info", message); }
        function notify_warning(message) { show_toastr("warning", message); }
        function notify_failed(message) { show_toastr("error", message); }
    </script>

    <!-- GLOBAL CONSTANTS -->
    <script>
        const SYSTEM_PROGRAM_ID = solanaWeb3.SystemProgram.programId;
        const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
        const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL");
        const SYSVAR_RENT_PUBKEY = solanaWeb3.SYSVAR_RENT_PUBKEY;
        const WRAPPED_SOL_MINT = new solanaWeb3.PublicKey("So11111111111111111111111111111111111111112");

        // 1) Download: https://mainnet-zp2-v2.orca.so/tokens
        // 2) $ cat tokens.json | jq -r 'map({ mint: .mint, symbol: .symbol})' | jq -c
        const TOKENS_JSON = [{"mint":"So11111111111111111111111111111111111111112","symbol":"SOL"},{"mint":"mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So","symbol":"mSOL"},{"mint":"MNDEFzGvMt87ueuHvVU9VcTqsAP5b3fTGPsHuuPA5ey","symbol":"MNDE"},{"mint":"7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj","symbol":"stSOL"},{"mint":"F6v4wfAdJB8D8p77bMXZgYt8TDKsYxLYxH5AFhUkYx9W","symbol":"wLUNA"},{"mint":"SHDWyBxihqiCj6YekG2GUr7wqKLeLAMK1gHZck9pL6y","symbol":"SHDW"},{"mint":"9vMJfxuKxXBoEa7rM12mYLMwTacLMLDJqHozw96WQL8i","symbol":"wUST"},{"mint":"7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU","symbol":"SAMO"},{"mint":"Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB","symbol":"USDT"},{"mint":"HZRCwxP2Vq9PCpPXooayhJ2bxTpo5xfpQrwB1svh332p","symbol":"wLDO"},{"mint":"7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs","symbol":"whETH"},{"mint":"9n4nbM75f5Ui33ZbPYXn59EwSgE8CGsHtAeTH5YFeJ9E","symbol":"BTC"},{"mint":"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v","symbol":"USDC"},{"mint":"orcaEKTdK7LKz57vaAYr9QeNsVEPfiu6QeMU1kektZE","symbol":"ORCA"},{"mint":"9iLH8T7zoWhY7sBmj1WK9ENbWdS1nL8n9wAxaeRitTa6","symbol":"USH"},{"mint":"5PmpMzWjraf3kSsGEKtqdUsCoLhptg4yriZ17LKKdBBy","symbol":"HDG"},{"mint":"USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX","symbol":"USDH"},{"mint":"9nEqaUcb16sQ3Tn1psbkWqyhPdLmfHWjKGymREjsAgTE","symbol":"WOOF"},{"mint":"a11bdAAuV8iB2fu7X6AxAvDTo1QZ8FXB3kk5eecdasp","symbol":"ABR"},{"mint":"KgV1GvrHQmRBY8sHQQeUKwTm2r2h8t4C8qt12Cw1HVE","symbol":"wAVAX"},{"mint":"GNCjk3FmPPgZTkbQRSxr6nCvLtYMbXKMnRxg8BgJs62e","symbol":"CELO"},{"mint":"EsPKhGTMf3bGoy4Qm7pCv3UCcWqAmbC1UGHBTDxRjjD4","symbol":"FTM"},{"mint":"EdAhkbj5nF9sRM7XN7ewuW8C9XEUMs8P7cnoQ57SYE96","symbol":"FAB"},{"mint":"ZScHuTtqZukUrtZS43teTKGs2VqkKL8k4QCouR2n6Uo","symbol":"wstETH"},{"mint":"HBB111SCo9jkCejsZfz8Ec8nH7T6THF8KEKSnvwT6XK6","symbol":"HBB"},{"mint":"8HGyAAB1yoM1ttS7pXjHMa3dukTFGQggnFFH3hJZgzQh","symbol":"COPE"},{"mint":"5oVNBeEEQvYi1cX3ir8Dx5n1P7pdxydbGF2X4TxVusJm","symbol":"scnSOL"},{"mint":"7Q2afV64in6N6SeZsAAB81TJzwDoD6zpqmHkzi9Dcavn","symbol":"JSOL"},{"mint":"5Wsd311hY8NXQhkt9cWHwTnqafk7BGEbLu8Py3DSnPAr","symbol":"CMFI"},{"mint":"2HeykdKjzHKGm2LKHw8pDYwjKPiFEoXAz74dirhUgQvq","symbol":"SAO"},{"mint":"4SZjjNABoqhbd4hnapbvoEPEqT8mnNkfbEoAwALf1V8t","symbol":"CAVE"},{"mint":"MEANeD3XDdUmNMsRGjASkSWdC8prLYsoRJ61pPeHctD","symbol":"MEAN"},{"mint":"UNQtEecZ5Zb4gSSVHCAWUQEoNnSVEbWiKCi1v9kdUJJ","symbol":"UNQ"},{"mint":"Lrxqnh6ZHKbGy3dcrCED43nsoLkM1LTzU2jRfWe8qUC","symbol":"LARIX"},{"mint":"METAmTMXwdb8gYzyCPfXXFmZZw4rUsXX58PNsDg7zjL","symbol":"SLC"},{"mint":"GFX1ZjR2P15tmrSwow6FjyDYcEkoFb4p4gJCpLBjaxHD","symbol":"GOFX"},{"mint":"FANTafPFBAt93BNJVpdu25pGPmca3RfwdsDsRrT3LX1r","symbol":"FANT"},{"mint":"SuperbZyz7TsSdSoFAZ6RYHfAWe9NmjXBLVQpS8hqdx","symbol":"SB"},{"mint":"xxxxa1sKNGwFtw2kFn8XauW9xq8hBZ5kVtcSesTT9fW","symbol":"SLIM"},{"mint":"4ThReWAbAVZjNVgs5Ui9Pk3cZ5TYaD9u6Y89fp6EFzoF","symbol":"1SOL"},{"mint":"seedEDBqu63tJ7PFqvcbwvThrYUkQeqT6NLf81kLibs","symbol":"SEEDED"},{"mint":"iVNcrNE9BRZBC9Aqf753iZiZfbszeAVUoikgT9yvr2a","symbol":"IVN"},{"mint":"StepAscQoEioFxxWGnh2sLBDFp9d8rvKz2Yp39iDpyT","symbol":"STEP"},{"mint":"F3nefJBcejYbtdREjui1T9DPh5dBgpkKq7u2GAAMXs5B","symbol":"AART"},{"mint":"8upjSpvjcdpuzhfR1zriwg5NXkwDruejqNE9WNbPRtyA","symbol":"GRAPE"},{"mint":"TuLipcqtGVXP9XR62wM8WWCm6a9vhLs7T1uoWBk6FDs","symbol":"TULIP"},{"mint":"Saber2gLauYim4Mvftnrasomsv6NvAuncvMEZwcLpD1","symbol":"SBR"},{"mint":"MangoCzJ36AjZyKwVj3VnYU4GTonjfVEnJmvvWaxLac","symbol":"MNGO"},{"mint":"SUNNYWgPQmFxe9wTZzNK7iPnJ3vYDrkgnxJRJm1s3ag","symbol":"SUNNY"},{"mint":"4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R","symbol":"RAY"},{"mint":"AGFEad2et2ZJif9jaGpdMixQqvW5i81aBdvKe7PHNfz3","symbol":"FTT"},{"mint":"SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt","symbol":"SRM"},{"mint":"PoRTjZMPXb9T7dyU7tpLEZRQj7e6ssfAE62j2oQuc6y","symbol":"PORT"},{"mint":"MAPS41MDahZ9QdKXhVa4dWB9RuyfV4XqhyAZ8XcYepb","symbol":"MAPS"},{"mint":"ETAtLmCmsoiEEKfNrHKJ2kYy3MoABhU6NQvpSfij5tDs","symbol":"MEDIA"},{"mint":"kinXdEcpDQeHPEuQnqmUgtYykqKGVFq6CeVX5iAHJq6","symbol":"KIN"},{"mint":"JET6zMJWkCN9tpRT2v2jfAmm5VnQFDpUBCyaKojmGtz","symbol":"JET"},{"mint":"AURYydfxJib1ZkTir1Jn1J9ECYUtjb6rKQVmtYaixWPP","symbol":"AURY"},{"mint":"SLNDpmoWTVADgEdndyvWzroNL7zSi1dF9PC3xHGtPwp","symbol":"SLND"},{"mint":"ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo","symbol":"ANA"},{"mint":"SLRSSpSLUTP7okbCUBYStWCo1vUgyt775faPqz8HUMr","symbol":"SLRS"},{"mint":"G9tt98aYSznRk7jWsfuz9FnTdokxS6Brohdo9hSmjTRB","symbol":"PUFF"},{"mint":"zebeczgi5fSEtbpfQKVZKCJ3WgYXxjkMUkNNx7fLKAF","symbol":"ZBC"},{"mint":"AG5j4hhrd1ReYi7d1JsZL8ZpcoHdjXvc8sdpWF74RaQh","symbol":"svtOKAY"},{"mint":"Ez2zVjw85tZan1ycnJ5PywNNxR6Gm4jbXQtZKyQNu3Lv","symbol":"fUSDC"},{"mint":"svtMpL5eQzdmB3uqK9NXaQkq8prGZoKQFNVJghdWCkV","symbol":"SVT"},{"mint":"AUrMpCDYYcPuHhyNX8gEEqbmDPFUpBpHrNW3vPeCFn5Z","symbol":"AVAX"},{"mint":"kiTkNc7nYAu8dLKjQFYPx3BqdzwagZGBUrcb7d4nbN5","symbol":"depKI"},{"mint":"ATLASXmbPQxBUYbxPsV97usA3fPQYEqzQBUHgiFCUsXx","symbol":"ATLAS"},{"mint":"poLisWXnNRwC6oBu1vHiuKQzFjGL4XDSu4g9qjz9qVk","symbol":"POLIS"},{"mint":"7kbnvuGBxxj8AG9qp8Scn56muWGaRaFqxg1FsRp3PaFT","symbol":"UXD"},{"mint":"DUSTawucrTsGU8hcqRdHDCbuYhCPADMLM2VcCb8VnFnQ","symbol":"DUST"},{"mint":"EjmyN6qEC1Tf1JxiG1ae7UTJhUxSwk1TCWNWqxWV4J6o","symbol":"DAI"},{"mint":"UXPhBoR3qG4UCiGNJfV7MqhHyFqKN68g45GoYvAeL2M","symbol":"UXP"},{"mint":"kiGenopAScF8VF31Zbtx2Hg8qA5ArGqvnVtXb83sotc","symbol":"KI"},{"mint":"A9mUU4qviSctJVPJdBJWkb28deg915LYJKrzQ19ji3FM","symbol":"USDCet"},{"mint":"SNSNkV9zfG5ZKWQs6x4hxvBRV6s8SqMfSGCtECDvdMd","symbol":"SNS"},{"mint":"CDJWUqTcYTVAKXAVXoQZFes5JUFc7owSeq7eMQcDSbo5","symbol":"renBTC"},{"mint":"GEJpt3Wjmr628FqXxTgxMce1pLntcPV4uFi8ksxMyPQh","symbol":"daoSOL"},{"mint":"USDrbBQwQbQ2oWHUPfA8QBHcyVxKUq1xHyXsSLKdUq2","symbol":"USDr"},{"mint":"Hg35Vd8K3BS2pLB3xwC2WqQV8pmpCm3oNRGYP1PEpmCM","symbol":"eSOL"},{"mint":"6naWDMGNWwqffJnnXFLBCLaYu1y5U9Rohe5wwJPHvf1p","symbol":"SCRAP"},{"mint":"FoRGERiW7odcCBGU1bztZi16osPBHjxharvDathL5eds","symbol":"FORGE"},{"mint":"ratioMVg27rSZbSvBopUvsdrGUzeALUfFma61mpxc8J","symbol":"RATIO"},{"mint":"GePFQaZKHcWE5vpxHfviQtH5jgxokSs51Y5Q4zgBiMDs","symbol":"JFI"},{"mint":"iJF17JCu78E51eAgwtCwvgULHh2ZqCeRrcFP7wgcc6w","symbol":"I-JFI-Q4"},{"mint":"jJF1SrhzpyqYawE9ruSVKrHjfxjaG5TUMFB5vnXUWVm","symbol":"J-JFI"},{"mint":"jRAYPwLn4ZRGRSKu7GWu6B3Qx3Vj2JU88agUweEceyo","symbol":"J-RAY"},{"mint":"iRAYYHCNhEpbDiVt6QKK3Q57DMgw4p8zEKsVz3WfMjW","symbol":"I-RAY-Q4"}];
        const SYMBOLS = new Map(); TOKENS_JSON.map((t) => SYMBOLS.set(t.mint, t.symbol));
    </script>

    <!-- INSTRUCTION UTIL -->
    <script>
        function to_instruction(instructions=[], cleanup_instructions=[], signers=[]) {
          return {
            instructions,
            cleanup_instructions,
            signers,
          };
        }

        async function to_transaction(connection, payer, instructions) {
          const blockhash = await connection.getLatestBlockhash();
          const tx = new solanaWeb3.Transaction({feePayer: payer, ...blockhash});
          instructions.filter((ix) => ix.instructions.length > 0).map((ix) => tx.add(...ix.instructions));
          instructions.filter((ix) => ix.cleanup_instructions.length > 0).reverse().map((ix) => tx.add(...ix.cleanup_instructions));

          const signers = [];
          instructions.map((ix) => signers.push(...ix.signers));

          return { tx, signers };
        }

        function decimal_to_le_uint8array(n, length) {
          const uint8array = new Uint8Array(length);
          let remaining = n;
          for (let i=0; i<length && !remaining.isZero(); i++) {
            const mod = remaining.modulo(256);
            uint8array[i] = mod.toNumber();
            remaining = remaining.sub(mod).div(256);
          }
          return uint8array;
        }

        function decimal_to_u128_le_uint8array(n) {
          return decimal_to_le_uint8array(n, 16);
        }

        function decimal_to_u64_le_uint8array(n) {
          return decimal_to_le_uint8array(n, 8);
        }

        function merge_uint8arrays(uint8arrays) {
          const length = uint8arrays.reduce((prev, curr) => prev += curr.length, 0);
          const merged = new Uint8Array(length);
          
          let offset = 0;
          for (let i=0; i<uint8arrays.length; i++) {
            merged.set(uint8arrays[i], offset);
            offset += uint8arrays[i].length;
          }
          return merged;
        }
    </script>
    
    <!-- TOKEN UTIL -->
    <script>
        function to_ui_amount(u64_amount, decimals) {
          return u64_amount.div(Decimal.pow(10, decimals));
        }

        function adjust_for_slippage(u64_amount, slippage) {
          return u64_amount.mul(new Decimal(1).sub(slippage)).floor();
        }

        function derive_ata(owner, mint) {
          const seeds = [owner.toBytes(), TOKEN_PROGRAM_ID.toBytes(), mint.toBytes()];
          const [pubkey, bump] = solanaWeb3.PublicKey.findProgramAddressSync(seeds, ASSOCIATED_TOKEN_PROGRAM_ID);
          return pubkey;
        }

        function create_ata_ix(payer, owner, mint) {
          const ata = derive_ata(owner, mint);
          const keys = [
            { pubkey: payer, isSigner: true, isWritable: true },
            { pubkey: ata, isSigner: false, isWritable: true },
            { pubkey: owner, isSigner: false, isWritable: false },
            { pubkey: mint, isSigner: false, isWritable: false },
            { pubkey: SYSTEM_PROGRAM_ID, isSigner: false, isWritable: false },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
            { pubkey: SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
          ];

          const create_ata_ix = new solanaWeb3.TransactionInstruction({
            keys,
            programId: ASSOCIATED_TOKEN_PROGRAM_ID,
            data: new Uint8Array([0]),
          });

          return {
            address: ata,
            instruction: to_instruction([create_ata_ix])
          };
        }

        async function create_wsta_ix(connection, payer, owner, lamports) {
          const ACCOUNT_LEN = 165;
          const keypair = solanaWeb3.Keypair.generate();
          const rent_lamports = await connection.getMinimumBalanceForRentExemption(ACCOUNT_LEN);

          const create_account_ix = solanaWeb3.SystemProgram.createAccount({
            fromPubkey: payer,
            lamports: rent_lamports + lamports,
            newAccountPubkey: keypair.publicKey,
            programId: TOKEN_PROGRAM_ID,
            space: ACCOUNT_LEN,
          });

          const initialize_account_ix = new solanaWeb3.TransactionInstruction({
            keys: [
              { pubkey: keypair.publicKey, isSigner: false, isWritable: true },
              { pubkey: WRAPPED_SOL_MINT, isSigner: false, isWritable: false },
              { pubkey: owner, isSigner: false, isWritable: false },
              { pubkey: SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
            ],
            programId: TOKEN_PROGRAM_ID,
            data: new Uint8Array([1]),
          });

          const close_account_ix = new solanaWeb3.TransactionInstruction({
            keys: [
              { pubkey: keypair.publicKey, isSigner: false, isWritable: true },
              { pubkey: owner, isSigner: false, isWritable: true },
              { pubkey: owner, isSigner: true, isWritable: false },
            ],
            programId: TOKEN_PROGRAM_ID,
            data: new Uint8Array([9]),
          });

          return {
            address: keypair.publicKey,
            instruction: to_instruction([create_account_ix, initialize_account_ix], [close_account_ix], [keypair])
          };
        }

        async function resolve_or_create_ata(connection, payer, owner, mint, lamports=0) {
          // WSOL
          if ( mint.equals(WRAPPED_SOL_MINT) ) return await create_wsta_ix(connection, payer, owner, lamports);

          // ATA already created
          const ata = derive_ata(owner, mint);
          const created = await connection.getAccountInfo(ata);
          if ( created !== null ) return { address: ata, instruction: to_instruction() };

          // create ATA
          return create_ata_ix(payer, owner, mint);
        }
    </script>

    <!-- WHIRLPOOL SPECIFIC -->
    <script>
        const WHIRLPOOL_PROGRAM_ID = new solanaWeb3.PublicKey("whirLbMiicVdio4qvUfM5KAg6Ct8VwpYzGff3uctyCc");
        const DEPRECATED_WHIRLPOOLS_CONFIG = new solanaWeb3.PublicKey("4NPRn2WVyyCrKEQBFaog8dvTjPLK8ETddrZUyRLq61Bo");
        const DEFAULT_SLIPPAGE = new Decimal("0.01"); // 1%
        const TICKARRAY_SIZE = 88;

        function get_position_pubkey(position_mint_pubkey) {
          const seeds = [new TextEncoder().encode("position"), position_mint_pubkey.toBytes()];
          const [pubkey, bump] = solanaWeb3.PublicKey.findProgramAddressSync(seeds, WHIRLPOOL_PROGRAM_ID);
          return pubkey;
        }

        function get_tickarray_pubkey(whirlpool_pubkey, start_tick_index) {
          const seeds = [
            new TextEncoder().encode("tick_array"),
            whirlpool_pubkey.toBytes(),
            new TextEncoder().encode(start_tick_index.toString())
          ];
          const [pubkey, bump] = solanaWeb3.PublicKey.findProgramAddressSync(seeds, WHIRLPOOL_PROGRAM_ID);
          return pubkey;
        }

        function get_u128_decimal(le_uint8array) {
          return new Decimal("0x" + le_uint8array.reverse().toString("hex"));
        }

        function is_reward_initialized(token_mint, token_vault) {
          return !solanaWeb3.PublicKey.default.equals(token_mint) && !solanaWeb3.PublicKey.default.equals(token_vault);
        }

        function get_start_tick_index(tick_index, tick_spacing) {
          const ticks_in_array = TICKARRAY_SIZE * tick_spacing;
          const real_index = Math.floor(tick_index / ticks_in_array);
          return real_index * ticks_in_array;
        }

        function parse_mint_account(data_uint8array) {
          const data_view = new DataView(data_uint8array.buffer);
          // pub mint_authority: COption<Pubkey>, // 4+32
          // pub supply: u64,                     // 8
          // pub decimals: u8,                    // 1
          let offset = 4 + 32 + 8;
          const decimals = data_view.getUint8(offset);

          return { decimals };
        }

        function parse_position_account(data_uint8array) {
          const data_view = new DataView(data_uint8array.buffer);
          // ANAHOR DISC                // 8
          // pub whirlpool: Pubkey,     // 32
          // pub position_mint: Pubkey, // 32
          // pub liquidity: u128,       // 16
          // pub tick_lower_index: i32, // 4
          // pub tick_upper_index: i32, // 4

          let offset = 8;
          const whirlpool = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          const position_mint = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          const liquidity = get_u128_decimal(data_uint8array.slice(offset, offset+16)); offset += 16;
          const tick_lower_index = data_view.getInt32(offset, true); offset += 4;
          const tick_upper_index = data_view.getInt32(offset, true); offset += 4;
          
          return { whirlpool, position_mint, tick_lower_index, tick_upper_index, liquidity };
        }

        function parse_whirlpool_account(data_uint8array) {
          let data_view = new DataView(data_uint8array.buffer);
          // ANAHOR DISC                     // 8
          // pub whirlpools_config: Pubkey,  // 32
          // pub whirlpool_bump: [u8; 1],    // 1
          // pub tick_spacing: u16,          // 2
          // pub tick_spacing_seed: [u8; 2], // 2
          // pub fee_rate: u16,              // 2
          // pub protocol_fee_rate: u16,     // 2
          // pub liquidity: u128,            // 16
          // pub sqrt_price: u128,           // 16
          // pub tick_current_index: i32,    // 4
          // pub protocol_fee_owed_a: u64,   // 8
          // pub protocol_fee_owed_b: u64,   // 8
          // pub token_mint_a: Pubkey,       // 32
          // pub token_vault_a: Pubkey,      // 32
          // pub fee_growth_global_a: u128,  // 16
          // pub token_mint_b: Pubkey,       // 32
          // pub token_vault_b: Pubkey,      // 32
          // pub fee_growth_global_b: u128,  // 16
          // pub reward_last_updated_timestamp: u64,               // 8
          // pub reward_infos: [WhirlpoolRewardInfo; NUM_REWARDS], // 384
          //     pub mint: Pubkey,                    // 32
          //     pub vault: Pubkey,                   // 32
          //     pub authority: Pubkey,               // 32
          //     pub emissions_per_second_x64: u128,  // 16
          //     pub growth_global_x64: u128,         // 16
          let offset = 8;
          const whirlpools_config = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          offset += 1;
          const tick_spacing = data_view.getUint16(offset, true); offset += 2;
          offset += 2 + 2 + 2 + 16;
          const sqrt_price = get_u128_decimal(data_uint8array.slice(offset, offset+16)); offset += 16;
          offset += 4 + 8 + 8;
          const token_mint_a = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          const token_vault_a = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          offset += 16;
          const token_mint_b = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          const token_vault_b = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          offset += 16 + 8;
          const token_mint_r0 = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          const token_vault_r0 = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          offset += 32 + 16 + 16;
          const token_mint_r1 = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          const token_vault_r1 = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          offset += 32 + 16 + 16;
          const token_mint_r2 = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          const token_vault_r2 = new solanaWeb3.PublicKey(data_uint8array.slice(offset, offset+32)); offset += 32;
          offset += 32 + 16 + 16;

          return {
            whirlpools_config,
            tick_spacing,
            sqrt_price,
            token_mint_a, token_mint_b, token_mint_r0, token_mint_r1, token_mint_r2,
            token_vault_a, token_vault_b, token_vault_r0, token_vault_r1, token_vault_r2,
          };
        }

        function update_fees_and_rewards_ix(whirlpool_pubkey, position_pubkey, tickarray_lower_pubkey, tickarray_upper_pubkey) {
          const keys = [
            { pubkey: whirlpool_pubkey, isSigner: false, isWritable: true },
            { pubkey: position_pubkey, isSigner: false, isWritable: true },
            { pubkey: tickarray_lower_pubkey, isSigner: false, isWritable: false },
            { pubkey: tickarray_upper_pubkey, isSigner: false, isWritable: false },
          ];

          const ix = new solanaWeb3.TransactionInstruction({
            keys,
            programId: WHIRLPOOL_PROGRAM_ID,
            data: new Uint8Array([0x9a, 0xe6, 0xfa, 0x0d, 0xec, 0xd1, 0x4b, 0xdf]), // ANCHOR INSTRUCTION CODE
          });

          return to_instruction([ix]);
        }

        function collect_fees_ix(whirlpool_pubkey, position_authority, position_pubkey, position_token_account, owner_a, vault_a, owner_b, vault_b) {
          const keys = [
            { pubkey: whirlpool_pubkey, isSigner: false, isWritable: false },
            { pubkey: position_authority, isSigner: true, isWritable: false },
            { pubkey: position_pubkey, isSigner: false, isWritable: true },
            { pubkey: position_token_account, isSigner: false, isWritable: false },
            { pubkey: owner_a, isSigner: false, isWritable: true },
            { pubkey: vault_a, isSigner: false, isWritable: true },
            { pubkey: owner_b, isSigner: false, isWritable: true },
            { pubkey: vault_b, isSigner: false, isWritable: true },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
          ];

          const ix = new solanaWeb3.TransactionInstruction({
            keys,
            programId: WHIRLPOOL_PROGRAM_ID,
            data: new Uint8Array([0xa4, 0x98, 0xcf, 0x63, 0x1e, 0xba, 0x13, 0xb6]), // ANCHOR INSTRUCTION CODE
          });

          return to_instruction([ix]);
        }

        function collect_reward_ix(whirlpool_pubkey, position_authority, position_pubkey, position_token_account, owner_ri, vault_ri, reward_index) {
          const keys = [
            { pubkey: whirlpool_pubkey, isSigner: false, isWritable: false },
            { pubkey: position_authority, isSigner: true, isWritable: false },
            { pubkey: position_pubkey, isSigner: false, isWritable: true },
            { pubkey: position_token_account, isSigner: false, isWritable: false },
            { pubkey: owner_ri, isSigner: false, isWritable: true },
            { pubkey: vault_ri, isSigner: false, isWritable: true },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
          ];

          const ix = new solanaWeb3.TransactionInstruction({
            keys,
            programId: WHIRLPOOL_PROGRAM_ID,
            data: merge_uint8arrays([
              new Uint8Array([0x46, 0x05, 0x84, 0x57, 0x56, 0xeb, 0xb1, 0x22]), // ANCHOR INSTRUCTION CODE
              new Uint8Array([reward_index]),
            ]),
          });

          return to_instruction([ix]);
        }

        function decrease_liquidity_ix(whirlpool_pubkey, position_authority, position_pubkey, position_token_account, owner_a, vault_a, owner_b, vault_b, tickarray_lower_pubkey, tickarray_upper_pubkey, liquidity, min_a, min_b) {
          const keys = [
            { pubkey: whirlpool_pubkey, isSigner: false, isWritable: true },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
            { pubkey: position_authority, isSigner: true, isWritable: false },
            { pubkey: position_pubkey, isSigner: false, isWritable: true },
            { pubkey: position_token_account, isSigner: false, isWritable: false },
            { pubkey: owner_a, isSigner: false, isWritable: true },
            { pubkey: owner_b, isSigner: false, isWritable: true },
            { pubkey: vault_a, isSigner: false, isWritable: true },
            { pubkey: vault_b, isSigner: false, isWritable: true },
            { pubkey: tickarray_lower_pubkey, isSigner: false, isWritable: true },
            { pubkey: tickarray_upper_pubkey, isSigner: false, isWritable: true },
          ];

          const ix = new solanaWeb3.TransactionInstruction({
            keys,
            programId: WHIRLPOOL_PROGRAM_ID,
            data: merge_uint8arrays([
              new Uint8Array([0xa0, 0x26, 0xd0, 0x6f, 0x68, 0x5b, 0x2c, 0x01]), // ANCHOR INSTRUCTION CODE
              decimal_to_u128_le_uint8array(liquidity),
              decimal_to_u64_le_uint8array(min_a),
              decimal_to_u64_le_uint8array(min_b),
            ]),
          });

          return to_instruction([ix]);
        }

        function close_position_ix(position_authority, receiver, position_pubkey, position_mint_pubkey, position_token_account) {
          const keys = [
            { pubkey: position_authority, isSigner: true, isWritable: false },
            { pubkey: receiver, isSigner: false, isWritable: true },
            { pubkey: position_pubkey, isSigner: false, isWritable: true },
            { pubkey: position_mint_pubkey, isSigner: false, isWritable: true },
            { pubkey: position_token_account, isSigner: false, isWritable: true },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
          ];

          const ix = new solanaWeb3.TransactionInstruction({
            keys,
            programId: WHIRLPOOL_PROGRAM_ID,
            data: new Uint8Array([0x7b, 0x86, 0x51, 0x00, 0x31, 0x44, 0x62, 0x62]), // ANCHOR INSTRUCTION CODE
          });

          return to_instruction([ix]);
        }

        function tick_index_to_sqrt_price_x64(tick_index) {
          const x64 = Decimal.pow(2, 64);
          return Decimal.pow(new Decimal("1.0001"), tick_index).sqrt().mul(x64).floor();
        }

        function tick_index_to_price(tick_index, decimals_a, decimals_b) {
          const decimal_adjust = Decimal.pow(10, decimals_a - decimals_b);
          return Decimal.pow(new Decimal("1.0001"), tick_index).mul(decimal_adjust);
        }

        function get_token_amounts_from_liquidity(liquidity, current_sqrt_price_x64, lower_sqrt_price_x64, upper_sqrt_price_x64) {
          const lower = lower_sqrt_price_x64;
          const upper = upper_sqrt_price_x64;
          const current = Decimal.max(Decimal.min(current_sqrt_price_x64, upper), lower); // bounded
          const x64 = Decimal.pow(2, 64);

          // tokenA = L/current - L/upper = L*(upper - current) / (current * upper)
          const amount_a = liquidity.mul(x64).mul(upper.sub(current)).div(current.mul(upper)).floor();
          // tokenB = L*current - L*lower = L*(current - lower)
          const amount_b = liquidity.mul(current.sub(lower)).div(x64).floor();

          return { amount_a, amount_b };
        }

        function decrease_liquidity_quote(liquidity, current_sqrt_price_x64, lower_sqrt_price_x64, upper_sqrt_price_x64, slippage) {
          const amounts = get_token_amounts_from_liquidity(liquidity, current_sqrt_price_x64, lower_sqrt_price_x64, upper_sqrt_price_x64);
          return {
            amount_a: adjust_for_slippage(amounts.amount_a, slippage),
            amount_b: adjust_for_slippage(amounts.amount_b, slippage),
          };
        }

        async function list_whirlpool_positions(connection, wallet_pubkey) {
          const parsed_token_accounts = await connection.getParsedTokenAccountsByOwner(wallet_pubkey, { programId: TOKEN_PROGRAM_ID });

          // get position address candidates
          const candidates = [];
          for (let i=0; i<parsed_token_accounts.value.length; i++) {
            // value.N.account.data.parsed.info.{mint, tokenAmount.{uiAmountString, decimals}}
            const token_account = parsed_token_accounts.value[i].account.data.parsed.info;
            const amount = token_account.tokenAmount;

            if ( amount.uiAmountString === "1" && amount.decimals === 0 ) {
              const position_mint_pubkey = new solanaWeb3.PublicKey(token_account.mint);
              const position_pubkey = get_position_pubkey(position_mint_pubkey);
              candidates.push(position_pubkey);
            }
          }

          // get position account_info
          const position_account_infos = await connection.getMultipleAccountsInfo(candidates);

          const position_datas = [];
          const whirlpool_pubkeys = [];
          for (let i=0; i<candidates.length; i++) {
            if ( position_account_infos[i] === null ) continue;
            const position_data = parse_position_account(position_account_infos[i].data);
            position_datas.push({ pubkey: candidates[i], ...position_data });
            whirlpool_pubkeys.push(position_data.whirlpool);
          }

          // get whirlpool account_info
          const whirlpool_account_infos = await connection.getMultipleAccountsInfo(whirlpool_pubkeys);
          const positions = [];
          for (let i=0; i<whirlpool_account_infos.length; i++) {
            const whirlpool_data = parse_whirlpool_account(whirlpool_account_infos[i].data);
            positions.push({ ...position_datas[i], whirlpool_data });
          }

          // get mint account_info
          const mint_pubkey_set = new Set();
          positions.map((p) => mint_pubkey_set.add(p.whirlpool_data.token_mint_a.toBase58()).add(p.whirlpool_data.token_mint_b.toBase58()));
          const mint_pubkeys = Array.from(mint_pubkey_set).map((b58) => new solanaWeb3.PublicKey(b58));
          const mint_account_infos = await connection.getMultipleAccountsInfo(mint_pubkeys);
          const decimals_map = new Map();
          for (let i=0; i<mint_pubkeys.length; i++) {
            const mint_data = parse_mint_account(mint_account_infos[i].data);
            decimals_map.set(mint_pubkeys[i].toBase58(), mint_data.decimals);
          }

          // add decimals
          return positions.map((p) => {
            return {
              ...p,
              decimals_a: decimals_map.get(p.whirlpool_data.token_mint_a.toBase58()),
              decimals_b: decimals_map.get(p.whirlpool_data.token_mint_b.toBase58())
            }
          });
        }

        async function build_close_position_tx(connection, wallet_pubkey, position, amounts) {
          const whirlpool_data = position.whirlpool_data;
          const position_token_account = derive_ata(wallet_pubkey, position.position_mint)
          const tickarray_lower_pubkey = get_tickarray_pubkey(position.whirlpool, get_start_tick_index(position.tick_lower_index, whirlpool_data.tick_spacing));
          const tickarray_upper_pubkey = get_tickarray_pubkey(position.whirlpool, get_start_tick_index(position.tick_upper_index, whirlpool_data.tick_spacing));
          const r0_initialized = is_reward_initialized(whirlpool_data.token_mint_r0, whirlpool_data.token_vault_r0);
          const r1_initialized = is_reward_initialized(whirlpool_data.token_mint_r1, whirlpool_data.token_vault_r1);
          const r2_initialized = is_reward_initialized(whirlpool_data.token_mint_r2, whirlpool_data.token_vault_r2);

          const tokens_to_be_collected = new Set();
          tokens_to_be_collected.add(whirlpool_data.token_mint_a.toBase58());
          tokens_to_be_collected.add(whirlpool_data.token_mint_b.toBase58());
          if ( r0_initialized ) tokens_to_be_collected.add(whirlpool_data.token_mint_r0.toBase58());
          if ( r1_initialized ) tokens_to_be_collected.add(whirlpool_data.token_mint_r1.toBase58());
          if ( r2_initialized ) tokens_to_be_collected.add(whirlpool_data.token_mint_r2.toBase58());

          const ixs = [];
          const token_account_map = new Map();
          for (let b58 of tokens_to_be_collected) {
            const mint = new solanaWeb3.PublicKey(b58);
            const {address, instruction} = await resolve_or_create_ata(connection, wallet_pubkey, wallet_pubkey, mint);
            ixs.push(instruction);
            token_account_map.set(b58, address);
          }

          ixs.push(update_fees_and_rewards_ix(
            position.whirlpool,
            position.pubkey,
            tickarray_lower_pubkey,
            tickarray_upper_pubkey
          ));

          ixs.push(collect_fees_ix(
            position.whirlpool,
            wallet_pubkey,
            position.pubkey,
            position_token_account,
            token_account_map.get(whirlpool_data.token_mint_a.toBase58()),
            whirlpool_data.token_vault_a,
            token_account_map.get(whirlpool_data.token_mint_b.toBase58()),
            whirlpool_data.token_vault_b
          ));

          if ( r0_initialized ) ixs.push(collect_reward_ix(
            position.whirlpool,
            wallet_pubkey,
            position.pubkey,
            position_token_account,
            token_account_map.get(whirlpool_data.token_mint_r0.toBase58()),
            whirlpool_data.token_vault_r0,
            0
          ));

          if ( r1_initialized ) ixs.push(collect_reward_ix(
            position.whirlpool,
            wallet_pubkey,
            position.pubkey,
            position_token_account,
            token_account_map.get(whirlpool_data.token_mint_r1.toBase58()),
            whirlpool_data.token_vault_r1,
            1
          ));

          if ( r2_initialized ) ixs.push(collect_reward_ix(
            position.whirlpool,
            wallet_pubkey,
            position.pubkey,
            position_token_account,
            token_account_map.get(whirlpool_data.token_mint_r2.toBase58()),
            whirlpool_data.token_vault_r2,
            2
          ));

          ixs.push(decrease_liquidity_ix(
            position.whirlpool,
            wallet_pubkey,
            position.pubkey,
            position_token_account,
            token_account_map.get(whirlpool_data.token_mint_a.toBase58()),
            whirlpool_data.token_vault_a,
            token_account_map.get(whirlpool_data.token_mint_b.toBase58()),
            whirlpool_data.token_vault_b,
            tickarray_lower_pubkey,
            tickarray_upper_pubkey,
            position.liquidity,
            amounts.amount_a,
            amounts.amount_b
          ));

          ixs.push(close_position_ix(
            wallet_pubkey,
            wallet_pubkey,
            position.pubkey,
            position.position_mint,
            position_token_account
          ));

          return to_transaction(connection, wallet_pubkey, ixs);
        }
    </script>

    <!-- UI LOGIC -->
    <script>
        let cached_positions;
        let cached_wallet_pubkey;

        function get_short_address(pubkey, prefix_suffix_length=4) {
          const b58 = pubkey.toBase58();
          return b58.substring(0, prefix_suffix_length) + "..." + b58.substring(b58.length-prefix_suffix_length);
        }

        function get_symbol(pubkey) {
          const b58 = pubkey.toBase58();
          return SYMBOLS.get(b58) || get_short_address(pubkey);
        }

        function get_position_status(current_sqrt_price, tick_lower_index, tick_upper_index) {
          const lower_sqrt_price = tick_index_to_sqrt_price_x64(tick_lower_index);
          const upper_sqrt_price = tick_index_to_sqrt_price_x64(tick_upper_index);

          if ( current_sqrt_price.lt(lower_sqrt_price) ) return { status: "below", message: "Out of Range(Below)" };
          if ( current_sqrt_price.gt(upper_sqrt_price) ) return { status: "above", message: "Out of Range(Above)" };
          return { status: "in", message: "In Range" };
        }

        async function init_from_url() {
          const params = new URLSearchParams(window.location.search);
          if ( ! params.has("pubkey") ) return;

          $("#pubkey").val(params.get("pubkey"));
          await list();
        }

        async function list() {
          try {
            const pubkey = new solanaWeb3.PublicKey($("#pubkey").val());
            cached_wallet_pubkey = pubkey;
            $("#wallet_address").text(get_short_address(pubkey, 8));
          } catch ( err ) {
            console.log("err.message", err.message);
            notify_failed(`invalid pubkey`);
            return;
          }
          await list_positions();
        }

        async function list_positions() {
          const wallet_pubkey = cached_wallet_pubkey;
          const connection = new solanaWeb3.Connection("https://solana-api.projectserum.com", 'confirmed');

          try {
            notify_info(`listing positions...`);

            const positions = await list_whirlpool_positions(connection, wallet_pubkey);
            positions.sort((a, b) => {
              if ( a.whirlpool.toBase58() < b.whirlpool.toBase58() ) return -1;
              if ( a.whirlpool.toBase58() > b.whirlpool.toBase58() ) return +1;
              if ( a.position_mint.toBase58() < b.position_mint.toBase58() ) return -1;
              if ( a.position_mint.toBase58() > b.position_mint.toBase58() ) return +1;
              return 0;
            });

            cached_positions = positions;
            notify_success(`${cached_positions.length} positions found`);
          } catch ( err ) {
            console.log("err.message", err.message);
            notify_failed(`listing positions failed`);
          }

          // UI rebuild
          $("#positions").find("tr").remove();
          for (let i=0; i<cached_positions.length; i++) {
            const p = cached_positions[i];

            const status = get_position_status(p.whirlpool_data.sqrt_price, p.tick_lower_index, p.tick_upper_index);
            const symbol_a = get_symbol(p.whirlpool_data.token_mint_a);
            const symbol_b = get_symbol(p.whirlpool_data.token_mint_b);

            const price_lower = tick_index_to_price(p.tick_lower_index, p.decimals_a, p.decimals_b).toFixed(p.decimals_b);
            const price_upper = tick_index_to_price(p.tick_upper_index, p.decimals_a, p.decimals_b).toFixed(p.decimals_b);

            const amounts = decrease_liquidity_quote(
              p.liquidity,
              p.whirlpool_data.sqrt_price,
              tick_index_to_sqrt_price_x64(p.tick_lower_index),
              tick_index_to_sqrt_price_x64(p.tick_upper_index),
              DEFAULT_SLIPPAGE
            );
            const ui_amount_a = to_ui_amount(amounts.amount_a, p.decimals_a);
            const ui_amount_b = to_ui_amount(amounts.amount_b, p.decimals_b);

            const html = `
              <tr class="${status.status}">
                <td>
                  <a href="https://solscan.io/account/${p.position_mint.toBase58()}" target="_blank">
                  <span title="${p.pubkey.toBase58()}">${get_short_address(p.position_mint, 5)}</span>
                  </a>
                </td>
                <td>${status.message}</td>
                <td>
                  <a href="https://solscan.io/account/${p.whirlpool.toBase58()}" target="_blank">
                  ${symbol_a}/${symbol_b}
                  (<span title="${p.whirlpool.toBase58()}">${get_short_address(p.whirlpool, 5)}</span>)
                  </a>
                </td>
                <td>${price_lower} - ${price_upper} ${symbol_b}</td>
                <td>${p.liquidity.toString()}</td>
                <td>${ui_amount_a} ${symbol_a} <br> ${ui_amount_b} ${symbol_b}</td>
              </tr>`;
            $("#positions").append(html);
          }

          if ( cached_positions.length == 0 ) {
            const html = `<tr><td class="empty-table" colspan="6">no position found</td></tr>`;
            $("#positions").append(html);
          }
        }

        $(document).ready(() => init_from_url());
    </script>
</head>
<body>

<h1>🌀Whirlpool Positions</h1>

<h2>PublicKey</h2>
<p>
  <input id="pubkey" type="text" size="60">
  <button class="connect" onclick="list();">list positions</button>
</p>

<hr>

<h2>Positions</h2>
<p style="font-size: small;">
  Wallet PublicKey: <span id="wallet_address"></span>
</p>
<table border="1" style="font-size: x-small;">
    <thead>
        <tr>
            <th>position</th>
            <th>status</th>
            <th>pool</th>
            <th>range</th>
            <th>liquidity</th>
            <th>tokenA & B</th>
        </tr>
    </thead>
    <tbody id="positions" style="text-align: right;">
    <tr><td class="empty-table" colspan="6">no putlic key</td></tr>
    </tbody>
</table>

</body>
</html>
